<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tally Counter</title>
  <script type="module">
    // Firebase v9+ modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Firebase config (safe to leave in frontend)
    const firebaseConfig = {
      apiKey: "AIzaSyCoBgZrJy-FL01VOEUSBFv8t_dYDCdVPK0",
      authDomain: "dyfjp-tally.firebaseapp.com",
      databaseURL: "https://dyfjp-tally-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dyfjp-tally",
      storageBucket: "dyfjp-tally.firebasestorage.app",
      messagingSenderId: "709741291824",
      appId: "1:709741291824:web:3dc61620407d77eb7380f5",
      measurementId: "G-Z0M0KMQDLB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const provider = new GoogleAuthProvider();

    // Replace these with your 2 Google account UIDs
    const allowedUIDs = ["hLz86iehQogvh45NTRdceZDKDlg2", "Muo0AtihzwN44D7ktyEInA09SHj2"];

    // DOM Elements
    const counterEl = document.getElementById("counter");
    const plusBtn = document.getElementById("plusBtn");
    const resetBtn = document.getElementById("resetBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const toast = document.getElementById("toast");

    // Show toast function
    function showToast(message) {
      toast.innerText = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (allowedUIDs.includes(user.uid)) {
          plusBtn.style.display = "inline-block";
          resetBtn.style.display = "inline-block";
        } else {
          plusBtn.style.display = "none";
          resetBtn.style.display = "none";
          showToast("You are signed in, but not allowed to update.");
        }
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        plusBtn.style.display = "none";
        resetBtn.style.display = "none";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    });

    // Buttons
    loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider).catch(err => showToast(err.message));
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).catch(err => showToast(err.message));
    });

    plusBtn.addEventListener("click", async () => {
      const snap = await get(child(ref(db), "counter"));
      const val = snap.exists() ? snap.val() : 0;
      set(ref(db, "counter"), val + 1);
    });

    resetBtn.addEventListener("click", () => {
      set(ref(db, "counter"), 0);
    });

    // Live counter update
    onValue(ref(db, "counter"), (snapshot) => {
      counterEl.innerText = snapshot.val() ?? 0;
    });

  </script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #counter { font-size: 4rem; font-weight: bold; margin: 1rem; }
    button {
      margin: 0.5rem; padding: 0.5rem 1rem;
      font-size: 1.2rem; border-radius: 8px; border: none;
      background: #eee; cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #ddd; }
    #toast {
      visibility: hidden; min-width: 250px;
      background: #333; color: #fff;
      text-align: center; border-radius: 5px;
      padding: 12px; position: fixed; z-index: 1;
      bottom: 30px; left: 50%; transform: translateX(-50%);
      opacity: 0; transition: opacity 0.5s, visibility 0.5s;
    }
    #toast.show {
      visibility: visible; opacity: 1;
    }
  </style>
</head>
<body>
  <div id="counter">0</div>
  <button id="plusBtn" style="display:none;">+1</button>
  <button id="resetBtn" style="display:none;">Reset</button>
  <br>
  <button id="loginBtn">Sign In with Google</button>
  <button id="logoutBtn" style="display:none;">Sign Out</button>
  <div id="toast"></div>
</body>
</html>
